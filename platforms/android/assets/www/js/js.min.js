/*js全局变量*/
//监听wife
document.addEventListener("deviceready", onDeviceReady, false);
function onDeviceReady() {
    checkConnection();
}

function checkConnection() {
    var networkState = navigator.connection.type;

    var states = {};
    states[Connection.UNKNOWN]  = 'Unknown connection';
    states[Connection.ETHERNET] = 'Ethernet connection';
    states[Connection.WIFI]     = 'WiFi connection';
    states[Connection.CELL_2G]  = 'Cell 2G connection';
    states[Connection.CELL_3G]  = 'Cell 3G connection';
    states[Connection.CELL_4G]  = 'Cell 4G connection';
    states[Connection.CELL]     = 'Cell generic connection';
    states[Connection.NONE]     = 'No network connection';

    //alert('Connection type: ' + states[networkState]);
}

//打开数据库
var db = window.openDatabase("power", "1.0", "Cordova Demo", 200000);

//数据库创建
function populateDB(tx) { 
   var htmlobj= $.ajax({url:"http://app.cnksi.com.cn/qj/sync/full_sync",async:false});
   var arr = eval(htmlobj.responseText);
   $.each(arr,function(i,sql){tx.executeSql(sql);});
}
	

//数据库错误信息
function errorCB(err) {
    alert("Error processing SQL: "+err.message);
}

//数据库创建成功信息
function successCB() {
    alert("数据同步成功!");
}

//数据库查询单条件
function queryDB(tx) {
    tx.executeSql('SELECT * FROM member where name=? and pwd=?', ["杨眉","1"], querySuccess, errorCB);
}

//数据库查询巡视表列表
function cardDB(tx) {
    tx.executeSql('SELECT * FROM card', [], cardSuccess, errorCB);
}
//数据库查询巡视表列表输出
function cardSuccess(tx, results) {
  	var len = results.rows.length;
   if(len>0){
	   for (var i=0; i<len; i++){
		  $('<li data-theme="c" id="lb_bg"><a href="#" onclick="smsd('+results.rows.item(i).psid+')" data-transition="slide">'+results.rows.item(i).cardname+'</a></li>').appendTo("#cardlist");
	    } 
	   $("#cardlist").listview('refresh');
   }else{
	   alert("没有要巡视的！");
   }
}

//转到扫描界面
function smsd(id){
	location.href = "smsd.html?id="+id;	
	//localStorage.id=urlid;
}

//数据库查询用户
function querymemberDB(tx,table,name,pwd) {	
	var table = table;
	var name = name;
	var pwd = pwd;
    tx.executeSql('SELECT * FROM '+ table +' where name=? and pwd=?', [name,pwd], memberSuccess, errorCB);
}

//数据库查询扫描后的
function querybarcodeDB(tx,table,psid) {
	var table = table;
	var psid = psid;
    tx.executeSql('SELECT * FROM '+ table +' where psid=?', [psid], barcodeSuccess, errorCB);
}

//查询扫描后的列表
function barcodeSuccess(tx, results) {
  	var len = results.rows.length;
    if(len>0){    
 	   //location.href = "xsd.html?iiid="+results.rows.item(1).iiid+"&psid="+results.rows.item(1).psid;
    	location.href = "xsd.html?&psid="+results.rows.item(0).psid;
    }else{
 	   alert("没有数据可查！")
    }
}
//数据库查询扫描后的
function queryxsdDB(tx,table,psid) {
	var table = table;
	var psid = psid;
    tx.executeSql('SELECT * FROM '+ table +' where psid=?', [psid], xsdSuccess, errorCB);
}
//查询扫描后的列表
function xsdSuccess(tx, results) {
  	var len = results.rows.length;
    if(len>0){    
    	for (var i=0; i<len; i++){    		
    		$('<li data-theme="c" id="lb_bg"><a href="#" onclick="xsd('+results.rows.item(i).iiid+')" data-transition="slide" >'+results.rows.item(i).name+'</a></li>').appendTo("#xsdlist");
        }
    	$("#xsdlist").listview('refresh');
    }else{
 	   alert("没有数据可查！")
    }
}
//转到巡视内容
function xsd(xsnrid){
	location.href = "xsnr.html?xsnrid="+xsnrid;	
	//localStorage.id=urlid;
}

//数据库查询扫巡视内容
function xsnrDB(tx,table,iiid) {
	var table = table;
	var iiid = iiid;
    tx.executeSql('SELECT a.iiid,a.did,a.icid,b.dpid,b.name FROM card_content_ref a LEFT JOIN device_part b on a.did=b.did WHERE a.iiid=?', [iiid], xsnrSuccess, errorCB);
}

//数据库查询扫巡视内容输出
function xsnrSuccess(tx, results) {
  	var len = results.rows.length;
  	if(len>0){
	  	for (var i=0; i<len; i++){
	  		$('#xsnrv').append('<div data-role="collapsible" data-theme="b" data-collapsed="true" data-content-theme="c" data-collapsed-icon="true"><h3 onclick="nrlistview('+results.rows.item(i).dpid+')">'+results.rows.item(i).name+'</h3><ul data-role="listview" id="nrlistview'+results.rows.item(i).dpid+'"></ul></div>').trigger("create");	  
	    }
  	}else{
 	   alert("没有数据可查！")
    }  	
}

//数据库查询扫巡视内容列表输出
function nrlistview(dpids){
	var dpid =dpids;
	db.transaction(function (t) {
	    t.executeSql('SELECT * FROM inspection_content c WHERE c.dpid IN('+dpid+')', [], function (t, r) {
	      lens = r.rows.length;
	      if(lens > 0){
	    	 if( $("#nrlistview"+dpid).html()==""){
		    	  for (var i=0; i<lens; i++){    		
		      		$('<li id="lb_bg"><a href="#">'+r.rows.item(i).content+'</a><p id="shuoming1">一般缺陷</p></li>').appendTo("#nrlistview"+dpid);
		          }
		    	  $("#nrlistview"+dpid).listview('refresh');
	    	 }else{}
	      }else{}
	    });
	});	
}
//用户验证
function memberSuccess(tx, results) {
  	var len = results.rows.length;
   if(len>0){
	   /*window.localStorage.setItem("key", results.rows.item(1).mid);
	   var keyname = window.localStorage.key(i);
	   var value = window.localStorage.getItem("key");*/
	   location.href = "xunjianliebiao.html";
   }else{
	   alert("用户名或密码错误！")
   }
}

//数据库查询后输出
function querySuccess(tx, results) {
  	var len = results.rows.length;
    console.log("DEMO table: " + len + " rows found.");
    for (var i=0; i<len; i++){
    	alert(results.rows.item(i).name+" "+results.rows.item(i).pwd);
    }
}

//数据同步
$(function(){
	$("#btnSync").click(function(){
		db.transaction(populateDB, errorCB, successCB);//连同数据库创建创建表和字段
		//db.transaction(queryDB, errorCB);//查询
	});
	$("#usersubmit").click(function(){
		usersubmit();
	});
});

//用户登录
function usersubmit(){
	var name = $("#name").val();
	var pwd = $("#pwd").val();
	if(name!="" && name!="请输入账号" && pwd!="" && pwd!="请输入密码"){
		db.transaction(function(tx){querymemberDB(tx,"member",name,pwd)}, errorCB);
	}else{
		alert("请输入用户名和密码！");
	}
}

//跳转时白屏
 $(document).bind("mobileinit", function () {
        $.extend($.mobile, {
            defaultPageTransition : 'none'
        });
 
        $.mobile.defaultPageTransition = 'none';
        $.mobile.defaultDialogTransition = 'none';
    });